# Earnifiy — Complete. Earn. Withdraw.

Telegram WebApp built with React + Vite + TS, Tailwind (dark crypto theme), and Supabase backend.

## Setup

1. Environment variables (create `.env` in project root):

```
VITE_SUPABASE_URL=https://YOUR-PROJECT.supabase.co
VITE_SUPABASE_ANON_KEY=YOUR_PUBLIC_ANON_KEY
```

2. Install deps and run:

```
npm install
npm run dev
```

3. Telegram integration:
- Open as WebApp inside a Telegram bot
- For local dev, you can simulate user via query params: `/?tg_id=123&tg_user=test&ref=123`

4. Ads integration:
- Replace placeholder `window.show_9651692` with the actual Monotag SDK script in `index.html`.

## Supabase

SQL schema (run in Supabase SQL editor):

```sql
-- users
create table if not exists users (
  id bigint generated by default as identity primary key,
  telegram_id text unique not null,
  username text,
  coins bigint default 0 not null,
  banned boolean default false not null,
  referrals int default 0 not null,
  created_at timestamp with time zone default now()
);

-- tasks
create table if not exists tasks (
  id bigint generated by default as identity primary key,
  type text not null,
  title text not null,
  reward int not null,
  link text,
  created_at timestamp with time zone default now()
);

-- withdrawals
create table if not exists withdrawals (
  id bigint generated by default as identity primary key,
  user_id bigint references users(id) on delete cascade,
  wallet text not null,
  coins bigint not null,
  usdt_value numeric not null,
  status text check (status in ('pending','approved','rejected')) default 'pending',
  txid text,
  rejection_reason text,
  created_at timestamp with time zone default now()
);

-- referrals
create table if not exists referrals (
  id bigint generated by default as identity primary key,
  referrer_id bigint references users(id) on delete cascade,
  new_user_id bigint references users(id) on delete cascade,
  created_at timestamp with time zone default now()
);

-- settings
create table if not exists settings (
  id bigint generated by default as identity primary key,
  exchange_rate numeric default 100 not null,
  created_at timestamp with time zone default now()
);

-- RPC for safe coin increment
create or replace function increment_coins(p_telegram_id text, p_amount int)
returns void language plpgsql as $$
begin
  update users set coins = coins + p_amount where telegram_id = p_telegram_id;
end;
$$;

-- Realtime on withdrawals status
-- Enable replication for withdrawals table in supabase (Database > Replication)

-- RLS policies
alter table users enable row level security;
alter table tasks enable row level security;
alter table withdrawals enable row level security;
alter table referrals enable row level security;
alter table settings enable row level security;

-- Users policies
create policy "select own user by telegram" on users
for select using (auth.role() = 'anon'); -- public read; tighten if needed

create policy "update own user coins via RPC only" on users
for update using (false) with check (false);

-- Referrals policies
create policy "insert referrals" on referrals
for insert with check (true);
create policy "select referrals" on referrals
for select using (true);

-- Withdrawals policies
create policy "insert withdrawals" on withdrawals
for insert with check (true);
create policy "select own withdrawals" on withdrawals
for select using (true);

-- Settings policies
create policy "select settings" on settings
for select using (true);
```

Edge function ideas (optional):
- Admin-only endpoints for ban/unban, adjust coins, approve/reject withdrawals with TxID, and broadcast messages.

## Pages
- Dashboard: coins, referrals, status
- Tasks: Monotag rewarded ads → increments coins
- Profile: user overview
- Withdraw: TRC20 wallet validation and request submission
- Leaderboard: top users by coins and referrals
- Referrals: invited list and personal referral link
- Admin: protected panel with stats and managers (scaffold)

## Security
- Admin UI restricted by Telegram id/username on client. For true security, secure mutations via Supabase RLS and Edge Functions with service role key.
- Validate inputs client-side; server-side rules must enforce integrity (e.g., coin increments via RPC only).

```js
// Example client call for ads reward
window.show_9651692('pop').then(() => {
  // Calls RPC increment_coins under RLS
})
```
